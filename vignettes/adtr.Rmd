---
title: "Creating ADTR"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating ADTR}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(admiral)
link <- function(text, url) {
  return(
    paste0(
      "[", text, "]",
      "(", url, ")"
    )
  )
}
dyn_link <- function(text,
                     base_url,
                     relative_url = "",
                     # Change to TRUE when admiral adopts multiversion docs
                     is_multiversion = FALSE,
                     multiversion_default_ref = "main") {
  url <- paste(base_url, relative_url, sep = "/")
  if (is_multiversion) {
    url <- paste(
      base_url,
      Sys.getenv("BRANCH_NAME", multiversion_default_ref),
      relative_url,
      sep = "/"
    )
  }
  return(link(text, url))
}
# Other variables
admiral_homepage <- "https://pharmaverse.github.io/admiral"
library(admiraldev)
```

# Introduction

This article describes creating an `ADTR` (Tumor Results) ADaM with common oncology
parameters based on RESIST v1.1.

The main part in programming a tumor results dataset is the calculation of the sum of diameters of all target lesions (lymph nodes & non-lymph nodes), the calculation of nadir, change in & percentage change from baseline, and the analysis flags that could be setup for reporting.  The tumor results data could be set up for investigator and/or Independent review facility (IRF)/Blinded Independent Central Review (BICR) data.

The source dataset used will depend on each company,  this could be solely the TR domain or you may merge TU with TR to get additional data variables or to ensure that you're processing the same lesions as collected.

Individual sum of diameter for each target lesion (from TR) is required to calculate the sum of all target lesions, this data could be taken directly from TR or additional parameters could be created in ADTR (or similar) depending on the additional processing required (e.g. imputation of dates, re-labelling of visits) and your company specifications.

NEED TO UPDATE THIS PART ONCE TEMPLATE CODE IS IN. The majority of the functions used here exist from `{admiral}`, except for the
`tte_sources` helper object, provided as an example from `{admiralonco}`.



**Note**: *All examples assume CDISC SDTM and/or ADaM format as input unless
otherwise specified.*

## Required Packages

The examples of this vignette require the following packages. (This is to be reviewed/updated once template code is written)

```{r, warning=FALSE, message=FALSE}
library(admiral)
library(dplyr)
library(admiral.test)
library(lubridate)
library(stringr)
library(admiralonco)
```

# Programming Workflow

* [Read in Data](#readdata)
* [Merge TR with TU and derive new variables](#merge)
* [Pre-processing of input records](#input)
* [Derive Parameters (`TLDn`, `TLPn`)](#parameters)
* [Derive Parameters (TSD) and ANL01FL](#tsd)
* [Derive Baseline (BASETYPE, ABLFL, BASE)](#base)
* [Derive NADIR](#nadir)
* [Derive Change from Baseline (CHG, PCHG)](#chg)
* [Derive Additional Flag Variables (e.g. CRFL, CRNFL, PDFL, PDFL](#addflag)
* [Derive Additional Analysis Flags (e.g. ANL02FL, ANL03FL, ANL04FL](#analflag)
* [Derive Analysis Sequence Number (`ASEQ`)](#aseq)
* [Add ADSL Variables](#adslvars)

## Read in Data {#readdata}

To start, all data frames needed for the creation of the tumor results dataset
should be read into the environment. This will be a company specific process. Some of the data frames needed may be `ADSL`, `ADRS` ,`RS`,  `TU` and `TR`.

For example purpose, the SDTM and ADaM datasets (based on CDISC Pilot test data)---which are included in `{admiral.test}`---are used

```{r}
data("admiral_adsl")
data("admiral_adrs")
data ("admiral_rs")
data("admiral_tu")
data("admiral_tr")
adsl <- admiral_adsl
adrs <- admiral_adrs
tu <- admiral_tu
tr  <- admiral_tr
rs <- admiral_rs

tu <-convert_blanks_to_na(tu) %>% 
  filter(TUEVAL == "INVESTIGATOR")
tr <-convert_blanks_to_na(tr) %>% 
  filter(TREVAL == "INVESTIGATOR" & TRGRPID == "TARGET" & TRTESTCD == "DIAMETER")
rs <-convert_blanks_to_na(rs)
```

```{r echo=FALSE}
# work-around for https://github.com/pharmaverse/admiral.test/issues/98
# should be removed once the bug is fixed
tr <- ungroup(tr)
```

```{r echo=FALSE}
tr <- filter(tr, USUBJID %in% c("01-701-1015", "01-701-1023", "01-701-1028"))
```

At this step, it may be useful to join `ADSL` to your `TR` domain.  Only the
`ADSL` variables used for derivations are selected at this step.  The rest of
the relevant `ADSL` variables would be added later.

```{r eval=TRUE}
adsl_vars <- vars (RANDDT)
adtr <- derive_vars_merged(
  tr,
  dataset_add = adsl,
  new_vars = adsl_vars,
  by_vars = vars (STUDYID, USUBJID)
)
```

## Merge TR with TU and derive new variables {#merge}

Depending on your company specifications you may want to merge `TU` with `TR`.  As an example, here we are keeping the tumor location, and deriving a new variable for the tumor group site. You may want to process other variables like `ADT`.

```{r}
tr <- derive_vars_merged (
  tr,
  dataset_add = rename(tu, TRLNKID = TULNKID),
  new_vars = vars(TULOC),
  by_vars = vars (STUDYID, USUBJID, TRLNKID)
) %>% mutate(
  TULOCGR1 = if_else(
    TULOC == "LYMPH NODE",
    "NODAL",
    "NON-NODAL"
  )
)
```

```{r, echo=FALSE}
dataset_vignette(tr, display_vars = vars(USUBJID, TRLNKID, TULOC, TULOCGR1))
```  


In addition, you could create any additional new variables that are required downstream when deriving the required parameters. For example, here we include lesion ID expected and lesion ID assessed. (any other examples?)

<template code>

## Pre-processing of input records {#input}

The next step involves company-specific pre-processing of records for the required input to downstream parameter derivations.  See examples below.

### Partial Date Imputation and Deriving `ADT`, `ADTF`, `AVISIT` etc

If your data collection allows for partial dates, you could apply a company-specific imputation rule at this stage when deriving `ADT`. For this example, here we impute missing day to earliest possible date

```{r}
tr <- derive_vars_dt(
  tr,
  dtc = TRDTC,
  new_vars_prefix = "A",
  highest_imputation = "D",
  date_imputation = "first"
)
```


```{r, echo=FALSE}
dataset_vignette(tr, display_vars = vars(USUBJID, TRLNKID, TRDTC, ADT, ADTF))
```  

### Re-labelling unscheduled visits

If you have data collected at unscheduled visits, which are not identified as unique in your SDTM or you have company specific rules.  Below is an example of how it could be re-labelled. <add more information once I see the template code>

```{r}
tr <- mutate(
  tr,
  AVISIT = VISIT,
  AVISITN = VISITNUM
)
```

## Derive Parameters TLDn and TLPn {#parameters}

As mentioned earlier, depending on your company specifications you may either create parameters for TLDn and TLPn in ADTR or similar dataset. 

Set the `AVALx/ANL01FL` variables.
```{r}
adtr <- tr %>%
    mutate(
      tmp_lesion_nr = str_sub(TRLNKID, 3),
      PARAMCD = paste0("DIAM", tmp_lesion_nr),
      PARAM = paste("Target Lesion", tmp_lesion_nr, "Analysis Diameter by Investigator"),
      PARCAT1 = "Target Lesion(s)",
      PARCAT2 = "Investigator",
      PARCAT3 = "Recist 1.1",
      AVAL = TRSTRESN,
      ANL01FL = if_else(!is.na(AVAL), "Y", NA_character_)
    ) %>%
  select(-tmp_lesion_nr)
```

```{r, echo=FALSE}
dataset_vignette(
  arrange(adtr, USUBJID, TRLNKID, AVISIT),
  display_vars = vars(USUBJID, TRLNKID, AVISIT, PARAMCD, PARAM, AVAL, ANL01FL))
```

## Derive Parameters (TSD) and Analysis Flag ANL01FL {#tsd}

Target Lesions Sum of Diameters is the sum of the diameters for lymph and
non-lymph nodes (sum of analysis values `AVAL` from source observations TLDn &
TLPn).  The analysis flag ANL01FL flags where the number of lesions assessed at
baseline and at post-baseline match.  To assess whether the number of lesions
expected and assessed match, you could compare lesion identifiers (TR.TRLNKID)
/use the previous variables set up earlier to compare lesion expected vs lesion
accessed  or check for target lesion response (from `RS`) =NE.

```{r}
adtr <- derive_summary_records(
  adtr,
  by_vars = vars(STUDYID, USUBJID, AVISIT, AVISITN),
  analysis_var = AVAL,
  summary_fun = function(x) sum(x, na.rm = TRUE),
  set_values_to = vars(
    PARAMCD = "TSD",
    PARAM = "Target Lesions Sum of Diameters by Investigator",
    PARCAT1 = "Target Lesion(s)",
    PARCAT2 = "Investigator",
    PARCAT3 = "Recist 1.1"
  )
)
```

```{r, echo=FALSE}
dataset_vignette(
  arrange(adtr, USUBJID, desc(PARAMCD), TRLNKID, AVISIT),
  display_vars = vars(USUBJID, AVISIT, PARAMCD, PARAM, AVAL))
```  

In the below example, the analysis flag, ANL01FL= Y identifies the largest
target lesion sum of diameter on a particular date for reporting if there were
multiple observations on the same date and where lesion assessed at
post-baseline match baseline.

<template code>

<show data frame so far>

## Derive Baseline (BASETYPE, ABLFL, BASE) {#base}

These functions are available in `admiral`, below examples show its usage for `ADTR` 

<template code>
<show data frame >

## Derive NADIR {#nadir}

Once we have a TSD parameter, the NADIR is set to the lowest sum of diameters in Analysis Value before the current observation, where Analysis Flag 01 =Y.  The first observations after baseline (depending on how you have defined baseline earlier) is set to analysis value where baseline record flag = Y

<template code>
<dataset so far>

## Derive Change from Baseline (CHG, PCHG) {#chg}

These functions are available in admiral, below examples show its usage for `ADTR`.  We calculate the change from baseline and percentage change from baseline for the parameter TSD and the variable  NADIR.

## Derive Additional Flag Variables {#addflag}

Depending on the analysis flags you require, you may want to create additional flag variables that will then aid setting up any additional analysis flag variables defined as per your company specifications.

###  Derive CRFL, CRNFL

In this example, CRFL flags where the patient has had Complete Response, and CRNFL, flags where Complete response contributed to the NADIR calculation.

<template code>
<show dataset so far>

### Derive PDFL

In this example, we want to flag when a patient has had PD.  This could be done in a number of ways 1) take the date of PD from `ADRS`  2) take the first date when the overall response is PD from `RS` or  3) Calculate from source data, the derivation for PD for target lesions is based on the calculated sum of diameters of the assessed lesions results in a calculated Percent Change from NADIR >=20% and a calculated Change form NADIR >=5mm depending on your company specifications.  See below example.


## Derive Analysis Flags ANL02FL, ANL03FL, ANL04FL {#analflag}

Based on your analysis, additional analysis flags could be set up in `ADTR`.  Below are some examples

Analysis 02 Flag only includes the visit with the lowest NADIR (lowest sum of diameter) compared across all visits.  Use PCHGNNAD or PCHG?

<template code>

Analysis 03 flag includes ANL01FL=Y and the target lesion sum of diameter until patient has had PD. Use the PDFL variable.

<template code>

Analysis 04 flag includes all sum of diameters even where lesion identifiers match and unmatch if the patient has had PD. Use CRFL, CRNFL, PDFL variables.

<template code>

<final dataset show with analysis flags>


## Derive Analysis Sequence Number (`ASEQ`) {#aseq}

The `{admiral}` function `admiral::derive_var_obs_number()` can be used to derive `ASEQ`:

```{r eval=TRUE}
adtr <- adtr %>%
  derive_var_obs_number(
    by_vars = vars(STUDYID, USUBJID),
    order = vars(PARAMCD, AVISITN, TRSEQ),
    check_type = "error"
  )
```

```{r, echo=FALSE}
dataset_vignette(adtr)
```  


## Add ADSL Variables {#adslvars}
  
If needed, the other `ADSL` variables can now be added. List of ADSL
variables already merged held in vector `adsl_vars`.

```{r eval=TRUE}
adtr <- adtr %>%
  derive_vars_merged(
    dataset_add = select(adsl, !!!negate_vars(adsl_vars)),
    by_vars = vars(STUDYID, USUBJID)
  )
```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adtr,
  display_vars = vars(USUBJID, RFSTDTC, RFENDTC, DTHDTC, DTHFL, AGE, AGEU),
  filter = USUBJID == "01-701-1015"
)
```


# Example Script {#example}

ADaM | Sample Code
---- | --------------
ADTR | [ad_adtr.R](https://github.com/pharmaverse/admiralonco/blob/main/inst/templates/ad_adtr.R){target="_blank"}

